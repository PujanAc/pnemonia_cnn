{% extends 'detector/base.html' %}

{% block title %}Upload Image - Pneumonia AI Detection{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1><i class="fas fa-upload"></i> Upload Chest X-ray</h1>
        <p>Selected Model: <strong>{{ model_info.name }}</strong></p>
    </div>
</div>

<div class="container">
    <div class="upload-wrapper">
        <!-- Model Info Card -->
        <div class="selected-model-info">
            <div class="model-badge">
                <i class="fas fa-{% if model_type == 'custom_cnn' %}microchip{% else %}network-wired{% endif %}"></i>
                <div>
                    <h3>{{ model_info.name }}</h3>
                    <p>{{ model_info.description }}</p>
                </div>
            </div>
            <div class="model-specs">
                <span class="spec-item">
                    <i class="fas fa-chart-line"></i> {{ model_info.accuracy }}% Accuracy
                </span>
                <span class="spec-item">
                    <i class="fas fa-image"></i> {{ model_info.input_size.0 }}x{{ model_info.input_size.1 }} Input
                </span>
            </div>
            <a href="{% url 'detector:select_model' %}" class="change-model-link">
                <i class="fas fa-exchange-alt"></i> Change Model
            </a>
        </div>

        <!-- Upload Form -->
        <div class="upload-form-card">
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>Drop your X-ray image here</h3>
                    <p>or click to browse</p>
                    <input type="file" name="image" id="imageInput" accept="image/jpeg,image/png,image/jpg" required>
                    
                    <div class="upload-requirements">
                        <p><i class="fas fa-info-circle"></i> Requirements:</p>
                        <ul>
                            <li>Format: JPG or PNG</li>
                            <li>Maximum size: 10MB</li>
                            <li>Chest X-ray images only</li>
                        </ul>
                    </div>
                </div>

                <!-- Preview Area -->
                <div class="image-preview" id="imagePreview" style="display: none;">
                    <div class="preview-header">
                        <h4><i class="fas fa-eye"></i> Preview</h4>
                        <button type="button" class="btn-remove" id="removeImage">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <img id="previewImg" src="" alt="Preview">
                    <div class="image-info" id="imageInfo"></div>
                </div>

                <!-- Error Display -->
                {% if form.errors %}
                <div class="form-errors">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i> {{ error }}
                        </div>
                        {% endfor %}
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Submit Button -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large" id="submitBtn" disabled>
                        <i class="fas fa-brain"></i> Analyze with AI
                    </button>
                </div>
            </form>
        </div>

        <!-- Guidelines -->
        <div class="guidelines-card">
            <h3><i class="fas fa-clipboard-list"></i> Image Guidelines</h3>
            <div class="guideline-items">
                <div class="guideline-item">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Good Quality</strong>
                        <p>Clear, high-resolution chest X-ray images</p>
                    </div>
                </div>
                <div class="guideline-item">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Proper Orientation</strong>
                        <p>Standard PA (posteroanterior) or AP (anteroposterior) view</p>
                    </div>
                </div>
                <div class="guideline-item">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Full Chest View</strong>
                        <p>Complete view of lungs and chest cavity</p>
                    </div>
                </div>
                <div class="guideline-item warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Not for Diagnosis</strong>
                        <p>This tool is for educational purposes only</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Processing Image...</h3>
        <p>AI is analyzing the X-ray and generating explainability visualizations</p>
        <div class="loading-steps">
            <div class="step active">
                <i class="fas fa-upload"></i> Uploading
            </div>
            <div class="step">
                <i class="fas fa-cog"></i> Preprocessing
            </div>
            <div class="step">
                <i class="fas fa-brain"></i> AI Analysis
            </div>
            <div class="step">
                <i class="fas fa-fire"></i> Generating Grad-CAM
            </div>
        </div>
    </div>
</div>

<style>
.upload-area {
    border: 3px dashed #ccc;
    border-radius: 12px;
    padding: 3rem;
    text-align: center;
    background: #fafafa;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.upload-area:hover {
    border-color: #2196F3;
    background: #f0f7ff;
}

.upload-area.drag-over {
    border-color: #2196F3;
    background: #e3f2fd;
}

.upload-area input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
}

.upload-icon i {
    font-size: 4rem;
    color: #2196F3;
    margin-bottom: 1rem;
}

.upload-requirements {
    margin-top: 2rem;
    text-align: left;
    background: white;
    padding: 1rem;
    border-radius: 8px;
}

.upload-requirements ul {
    margin: 0.5rem 0 0 1.5rem;
    color: #666;
}

.image-preview {
    margin-top: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.image-preview img {
    width: 100%;
    max-height: 400px;
    object-fit: contain;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
}

.image-info {
    margin-top: 1rem;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 8px;
    font-size: 0.9rem;
    color: #666;
}

.btn-remove {
    background: #f44336;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-remove:hover {
    background: #d32f2f;
}

.loading-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.loading-overlay.active {
    display: flex;
}

.loading-content {
    text-align: center;
    color: white;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 5px solid rgba(255,255,255,0.3);
    border-top-color: #2196F3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-steps {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-top: 2rem;
}

.loading-steps .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    opacity: 0.5;
}

.loading-steps .step.active {
    opacity: 1;
}

.loading-steps .step i {
    font-size: 1.5rem;
}
</style>

<script>
const uploadArea = document.getElementById('uploadArea');
const imageInput = document.getElementById('imageInput');
const imagePreview = document.getElementById('imagePreview');
const previewImg = document.getElementById('previewImg');
const imageInfo = document.getElementById('imageInfo');
const submitBtn = document.getElementById('submitBtn');
const removeImage = document.getElementById('removeImage');
const uploadForm = document.getElementById('uploadForm');
const loadingOverlay = document.getElementById('loadingOverlay');

// Handle file selection
imageInput.addEventListener('change', handleFileSelect);

// Handle drag and drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        imageInput.files = files;
        handleFileSelect();
    }
});

function handleFileSelect() {
    const file = imageInput.files[0];
    if (file) {
        // Validate file type
        if (!file.type.match('image/(jpeg|png|jpg)')) {
            alert('Please select a JPG or PNG image');
            return;
        }
        
        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB');
            return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            imagePreview.style.display = 'block';
            uploadArea.style.display = 'none';
            submitBtn.disabled = false;
            
            // Show file info
            const sizeKB = (file.size / 1024).toFixed(2);
            imageInfo.innerHTML = `
                <strong>File:</strong> ${file.name}<br>
                <strong>Size:</strong> ${sizeKB} KB<br>
                <strong>Type:</strong> ${file.type}
            `;
        };
        reader.readAsDataURL(file);
    }
}

// Remove image
removeImage.addEventListener('click', () => {
    imageInput.value = '';
    imagePreview.style.display = 'none';
    uploadArea.style.display = 'block';
    submitBtn.disabled = true;
});

// Form submission
uploadForm.addEventListener('submit', (e) => {
    loadingOverlay.classList.add('active');
    
    // Animate loading steps
    let stepIndex = 0;
    const steps = document.querySelectorAll('.loading-steps .step');
    const stepInterval = setInterval(() => {
        if (stepIndex > 0) {
            steps[stepIndex - 1].classList.remove('active');
        }
        if (stepIndex < steps.length) {
            steps[stepIndex].classList.add('active');
            stepIndex++;
        } else {
            clearInterval(stepInterval);
        }
    }, 800);
});
</script>
{% endblock %}